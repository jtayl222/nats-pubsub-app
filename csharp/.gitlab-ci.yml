# GitLab CI/CD Pipeline for NatsHttpGateway
# Designed for Linux runners with Docker executor

variables:
  DOTNET_VERSION: "8.0"
  NATS_URL: "nats://nats:4222"
  # Improve build performance
  DOTNET_CLI_TELEMETRY_OPTOUT: "true"
  DOTNET_NOLOGO: "true"

stages:
  - build
  - test
  - security-test
  - component-test
  - publish

# Base template for .NET jobs
.dotnet-base:
  image: mcr.microsoft.com/dotnet/sdk:8.0
  before_script:
    - dotnet --info
  cache:
    key: "${CI_COMMIT_REF_SLUG}-dotnet"
    paths:
      - .nuget/
    policy: pull-push

# ------------------------------------------------------------------------------
# BUILD STAGE
# ------------------------------------------------------------------------------
build:
  extends: .dotnet-base
  stage: build
  script:
    - dotnet restore NatsHttpGateway/NatsHttpGateway.sln --packages .nuget/
    - dotnet build NatsHttpGateway/NatsHttpGateway.sln --configuration Release --no-restore
  artifacts:
    paths:
      - "**/bin/Release/"
      - "**/obj/"
    expire_in: 1 hour

# ------------------------------------------------------------------------------
# UNIT TEST STAGE (excludes Component and Security categories)
# ------------------------------------------------------------------------------
unit-test:
  extends: .dotnet-base
  stage: test
  needs:
    - build
  script:
    - dotnet test NatsHttpGateway.Tests/NatsHttpGateway.Tests.csproj
        --configuration Release
        --no-build
        --filter "Category!=Component&Category!=Security"
        --logger "trx;LogFileName=unit-test-results.trx"
        --logger "console;verbosity=detailed"
        --collect:"XPlat Code Coverage"
        --results-directory ./results/unit
  artifacts:
    when: always
    paths:
      - results/
    expire_in: 1 week
  coverage: '/Total\s*\|\s*(\d+\.?\d*%)/'

# ------------------------------------------------------------------------------
# SECURITY TEST STAGE (no NATS required - tests auth configuration)
# ------------------------------------------------------------------------------
security-test:
  extends: .dotnet-base
  stage: security-test
  needs:
    - build
  script:
    # Run security unit tests (authorization attributes, TLS config validation)
    - dotnet test NatsHttpGateway.Tests/NatsHttpGateway.Tests.csproj
        --configuration Release
        --no-build
        --filter "Category=Security"
        --logger "trx;LogFileName=security-unit-test-results.trx"
        --logger "console;verbosity=detailed"
        --results-directory ./results/security-unit
    # Run security component tests (JWT validation - mocks NATS)
    - dotnet test NatsHttpGateway.ComponentTests/NatsHttpGateway.ComponentTests.csproj
        --configuration Release
        --no-build
        --filter "Category=Security"
        --logger "trx;LogFileName=security-component-test-results.trx"
        --logger "console;verbosity=detailed"
        --results-directory ./results/security-component
  artifacts:
    when: always
    paths:
      - results/
    reports:
      junit: results/**/*.trx
    expire_in: 1 week

# ------------------------------------------------------------------------------
# COMPONENT TEST STAGE (requires real NATS JetStream with mTLS)
# ------------------------------------------------------------------------------
component-test:
  stage: component-test
  image: mcr.microsoft.com/dotnet/sdk:8.0
  needs:
    - build
    - security-test
  services:
    - name: docker:24-dind
      alias: docker
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    NATS_URL: "tls://nats-tls:4222"
    CERTS_DIR: "${CI_PROJECT_DIR}/NatsHttpGateway.ComponentTests/test-certs"
  before_script:
    - dotnet --info
    # Install Docker CLI
    - apt-get update && apt-get install -y docker.io curl
  script:
    # Start NATS with TLS configuration
    - |
      echo "Starting NATS with mTLS..."
      docker run -d --name nats-tls \
        -p 4222:4222 -p 8222:8222 \
        -v ${CERTS_DIR}:/certs:ro \
        nats:latest \
        -c /certs/nats-server.conf
    # Wait for NATS to be ready
    - |
      echo "Waiting for NATS JetStream (TLS) to be ready..."
      NATS_IP=$(docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' nats-tls)
      echo "NATS container IP: ${NATS_IP}"
      for i in $(seq 1 30); do
        if curl -s http://${NATS_IP}:8222/healthz > /dev/null 2>&1; then
          echo "NATS is ready!"
          break
        fi
        echo "Waiting... ($i/30)"
        sleep 1
      done
    # Set environment variables for tests
    - export NATS_URL="tls://${NATS_IP}:4222"
    - export NATS_CA_FILE="${CERTS_DIR}/rootCA.pem"
    - export NATS_CERT_FILE="${CERTS_DIR}/client.pem"
    - export NATS_KEY_FILE="${CERTS_DIR}/client.key"
    # Run component tests
    - dotnet test NatsHttpGateway.ComponentTests/NatsHttpGateway.ComponentTests.csproj
        --configuration Release
        --no-build
        --filter "Category=Component"
        --logger "trx;LogFileName=component-test-results.trx"
        --logger "console;verbosity=detailed"
        --results-directory ./results/component
  after_script:
    - docker stop nats-tls || true
    - docker rm nats-tls || true
  artifacts:
    when: always
    paths:
      - results/
    reports:
      junit: results/**/*.trx
    expire_in: 1 week
  allow_failure: false
  cache:
    key: "${CI_COMMIT_REF_SLUG}-dotnet"
    paths:
      - .nuget/
    policy: pull

# ------------------------------------------------------------------------------
# DOCKER IMAGE PUBLISH STAGE
# ------------------------------------------------------------------------------
publish-image:
  stage: publish
  image: docker:24
  services:
    - docker:24-dind
  needs:
    - unit-test
    - security-test
    - component-test
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    - docker build -t $CI_REGISTRY_IMAGE/nats-http-gateway:$CI_COMMIT_SHA -f NatsHttpGateway/Dockerfile .
    - docker push $CI_REGISTRY_IMAGE/nats-http-gateway:$CI_COMMIT_SHA
    - |
      if [ "$CI_COMMIT_BRANCH" == "$CI_DEFAULT_BRANCH" ]; then
        docker tag $CI_REGISTRY_IMAGE/nats-http-gateway:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE/nats-http-gateway:latest
        docker push $CI_REGISTRY_IMAGE/nats-http-gateway:latest
      fi
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: manual
